<!DOCTYPE html>
<html>
<head>
  <link rel="shortcut icon" href="logogizmo_V8a_icon.ico">
    <title>NAO CONTROL</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

    <nav class="nav-extended purple darken-3">
      <div class="nav-wrapper">
        <a class="brand-logo center"><img id="logo" src="naokita.png" width="30px">NAOKITA Control</a>
      </div>
      <div class="nav-content purple darken-3">
        <ul class="tabs tabs-transparent">
          <li class="tab"><a class="active" href="#manualControl">Manual Control</a></li>
          <li id="tab2" class="tab disabled"><a href="#mereBelief">Mere Belief Answers</a></li>
          <li id="tab3" class="tab"><a href="#recursiveFeedback">Recursive Feedback</a></li>
        </ul>
      </div>
      </nav>
    <div class="container">
      <!-- FIRST TAB  -->
      <div id="manualControl" class="col s10">
        <div class="section">
          <h4 class="purple-text text-darken-3 center-align">Manual Control</h4>
          <div class="row">
            <div class="col s6 center">
              <a id="connect" class="waves-effect waves-light btn-large green lighten-2"><i class="material-icons left">settings_input_antenna</i>Connect to NAO</a>
              <a id="disconnect" class="waves-effect waves-light btn-large red disabled"><i class="material-icons left">highlight_off</i>Disconnect NAO</a>
              <div>STATUS: <span id="status">Disconnected</span><img id="greenLight" class="light" src="green_light.png" alt=""><img id="redLight"class="light" src="red_light.png" alt=""></div>
            </div>
            <div  id="controls"class="col s6 center">
              <a id="sleep" class="waves-effect waves-purple btn-large purple darken-2" onclick= "sleep()"><i class="material-icons left">brightness_3</i>Sleep</a>
              <a id="wakeUp" class="waves-effect waves-purple btn-large  yellow darken-1" onclick= "wakeUp()"><i class="material-icons left">brightness_7</i>Wake Up</a>
              <a id="stand" class="waves-effect waves-purple btn-large cyan lighten-1" onclick= "stand()">Stand</a>
            </div>
          </div>
            <div id="controls2">
              <div class="row">
                <div class="col s6">
                  <h5 class="purple-text text-darken-3 center-align">Movement Control</h5>
                  <div class="grid-container">
                    <div class="grid">
                      <a id="rotateLeft" class="btn-floating btn-large waves-effect waves-light purple darken-3"><i class="material-icons">replay</i></a>
                      <a id="forward" class="btn-floating btn-large waves-effect waves-light orange lighten-1"><i class="material-icons">keyboard_arrow_up</i></a>
                      <a id="rotateRight" class="btn-floating btn-large waves-effect waves-light purple darken-3"><i class="material-icons">replay</i></a>
                      <a id="left" class="btn-floating btn-large waves-effect waves-light orange lighten-1"><i class="material-icons">keyboard_arrow_left</i></a>
                      <img id="logo2" src="naokita.png" width="50px" height="50px">
                      <a id="right" class="btn-floating btn-large waves-effect waves-light orange lighten-1"><i class="material-icons">keyboard_arrow_right</i></a>
                      <div class="cell"></div>
                      <a id="back" class="btn-floating btn-large waves-effect waves-light orange lighten-1"><i class="material-icons">keyboard_arrow_down</i></a>
                      <div class="cell"></div>
                    </div>
                  </div>
                </div>
                <div class="col s6 center">
                  <h5 class="purple-text text-darken-3">Voice Control</h5>
                  <div class="col s6 center">
                    <form action="#">
                      <p class="range-field">
                        <input type="range" id="globalVolume" min="0" max="100"/>
                        <span>GLOBAL VOLUME</span>
                      </p>
                    </form>
                    <form action="#">
                      <p class="range-field">
                        <input type="range" step=0.1 id="speechVolume" min="1" max="4" onchange="updatePitch(this.value)"/>
                        <span>PITCH SHIFT</span>
                      </p>
                    </form>
                  </div>
                  <div class="col s6 center">
                    <form action="#">
                      <p class="range-field">
                        <input type="range" step=0.1 id="doubleVoice" min="1" max="4" onchange="updateDoubleVoice(this.value)"/>
                        <span>DOUBLE VOICE PITCH</span>
                      </p>
                    </form>
                    <form action="#">
                      <p class="range-field">
                        <input type="range" step=0.1 id="doubleVoiceLevel" min="0" max="4" onchange="updateDoubleVoiceLevel(this.value)"/>
                        <span>DOUBLE VOICE LEVEL</span>
                      </p>
                    </form>
                  </div>
                  <div class="col s6 center">
                    <form action="#">
                      <p class="range-field">
                        <input type="range" step=0.1 id="doubleVoiceTimeShift" min="0" max="0.5" onchange="updatedoubleVoiceTimeShift(this.value)"/>
                        <span>DOUBLE VOICE TIME SHIFT</span>
                      </p>
                    </form>
                  </div>
                  <div class="col s6 center">
                    <a id="test" class="waves-effect waves-purple btn-large green" onclick="animatedSay('Testing voice')"><i class="material-icons left"></i>Test</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- SECOND TAB  -->
      <div id="mereBelief" class="col s12">
        <div class="section">
          <h4 class="purple-text text-darken-3 center-align">Mere Belief Answers</h4>
          <div class="row">
            <div class="col s12 center">
              <a class="waves-effect waves-purple btn-large orange lighten-1" onclick= "$(this).addClass('greyText'); answer(1)"><i class="material-icons left">play_arrow</i>Answer 1</a>
              <a class="waves-effect waves-purple btn-large  orange lighten-1" onclick= "$(this).addClass('greyText'); answer(2)"><i class="material-icons left">play_arrow</i>Answer 2</a>
              <a class="waves-effect waves-purple btn-large  orange lighten-1" onclick= "$(this).addClass('greyText'); answer(3)"><i class="material-icons left">play_arrow</i>Answer 3</a>
              <a class="waves-effect waves-purple btn-large  orange lighten-1" onclick= "$(this).addClass('greyText'); answer(4)"><i class="material-icons left">play_arrow</i>Answer 4</a>
              <a class="waves-effect waves-purple btn-large  orange lighten-1" onclick= "$(this).addClass('greyText'); answer(5)"><i class="material-icons left">play_arrow</i>Answer 5</a>
              <a class="waves-effect waves-purple btn-large  orange lighten-1" onclick= "$(this).addClass('greyText'); answer(6)"><i class="material-icons left">play_arrow</i>Answer 6</a>
              <a class="waves-effect waves-purple btn-large  orange lighten-1" onclick= "$(this).addClass('greyText'); answer(7)"><i class="material-icons left">play_arrow</i>Answer 7</a>
              <a class="waves-effect waves-purple btn-large  orange lighten-1" onclick= "$(this).addClass('greyText'); answer(8)"><i class="material-icons left">play_arrow</i>Answer 8</a>
              <a class="waves-effect waves-purple btn-large  orange lighten-1" onclick= "$(this).addClass('greyText'); answer(9)"><i class="material-icons left">play_arrow</i>Answer 9</a>
              <a class="waves-effect waves-purple btn-large  purple lighten-1" onclick= "hello()"><i class="material-icons left">play_arrow</i>Hello!</a>
            </div>
          </div>
          <div class="divider"></div>
          <div class="row">
            <div class="col s12 center">
              <a id="stopAll" class="waves-effect waves-light btn-large disabled red" onclick= "stopBehavior()"><i class="material-icons left">stop</i>Stop Answer</a>
            </div>
          </div>
          <div class="divider"></div>
        </div>
      </div>
      <!-- THIRD TAB  -->
      <div id="recursiveFeedback">
        <div class="row">
          <div class="col s5 pane">
            <h4 class="purple-text text-darken-3 center-align">Animated Speech</h4>
            <p>Write message on the form...<p>
            <div class="center">
              <input id="inputText" type="text"/>
              <a id="submitText" class="waves-effect waves-purple btn-large purple darken-2" onclick= "sleep()"><i class="material-icons left">unarchive</i>Submit</a>
            </div>
              <div class="col s12">
                <form action="#">
                  <h5 class="purple-text text-darken-3 center-align">Voice Control</h5>
                  <span>VOLUME</span>
                  <p class="range-field">
                    <input type="range" id="speechVolume" min="0" max="100" onchange="updateSpeechVolume(this.value)"/>
                  </p>
                </form>
              </div>
          </div>
          <div class="col s6 pane offset-s1">
            <h5 class="purple-text text-darken-3 center-align">Recursive Feedback Answers</h5>
            <div class="col s6">
              <a class="waves-effect waves-purple btn  lime lighten-1" onclick= "$(this).addClass('greyText'); video(1)"><i class="material-icons left">play_arrow</i>Video 1</a>
              <a class="waves-effect waves-purple btn  lime lighten-1" onclick= "$(this).addClass('greyText'); video(2)"><i class="material-icons left">play_arrow</i>Video 2</a>
              <a class="waves-effect waves-purple btn  lime lighten-1" onclick= "$(this).addClass('greyText'); video(3)"><i class="material-icons left">play_arrow</i>Video 3</a>
              <a class="waves-effect waves-purple btn  lime lighten-1" onclick= "$(this).addClass('greyText'); video(4)"><i class="material-icons left">play_arrow</i>Video 4</a>
              <a class="waves-effect waves-purple btn  lime lighten-1" onclick= "$(this).addClass('greyText'); answer(5)"><i class="material-icons left">play_arrow</i>Answer 5</a>
              <a class="waves-effect waves-purple btn  lime lighten-1" onclick= "$(this).addClass('greyText'); answer(3)"><i class="material-icons left">play_arrow</i>Answer 3</a>
              <a class="waves-effect waves-purple btn  lime lighten-1" onclick= "$(this).addClass('greyText'); answer(9)"><i class="material-icons left">play_arrow</i>Answer 9</a>
              <a class="waves-effect waves-purple btn  lime lighten-1" onclick= "$(this).addClass('greyText'); answer(6)"><i class="material-icons left">play_arrow</i>Answer 6</a>
            </div>
            <div class="col s6">
              <a class="waves-effect waves-purple btn  purple lighten-1" onclick= "animatedSay('Well')"><i class="material-icons left">play_arrow</i>Well ...</a>
              <a class="waves-effect waves-purple btn  purple lighten-1" onclick= "animatedSay('Hmmm')"><i class="material-icons left">play_arrow</i>Hmmm ...</a>
              <a class="waves-effect waves-purple btn  purple lighten-1" onclick= "animatedSay('Give me a second')"><i class="material-icons left">play_arrow</i>Give me a second...</a>
              <a class="waves-effect waves-purple btn  purple lighten-1" onclick= "animatedSay('I'm sorry')"><i class="material-icons left">play_arrow</i>I'm sorry?</a>
              <a class="waves-effect waves-purple btn  purple lighten-1" onclick= "animatedSay('Can you repeat that?')"><i class="material-icons left">play_arrow</i>Can you repeat that?</a>
              <a class="waves-effect waves-purple btn  purple lighten-1" onclick= "animatedSay('hello!')"><i class="material-icons left">play_arrow</i>Hello!</a>
            </div>
          </div>
        </div>
        <h1 class="center" id="headline">
        <div id="info">
          <p id="info_start">Click on the microphone icon and begin speaking.</p>
          <p id="info_speak_now">Speak now.</p>
          <p id="info_no_speech">No speech was detected. You may need to adjust your
            <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892">
              microphone settings</a>.</p>
          <p id="info_no_microphone" style="display:none">
            No microphone was found. Ensure that a microphone is installed and that
            <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892">
            microphone settings</a> are configured correctly.</p>
          <p id="info_allow">Click the "Allow" button above to enable your microphone.</p>
          <p id="info_denied">Permission to use microphone was denied.</p>
          <p id="info_blocked">Permission to use microphone is blocked. To change,
            go to chrome://settings/contentExceptions#media-stream</p>
          <p id="info_upgrade">Web Speech API is not supported by this browser.
             Upgrade to <a href="//www.google.com/chrome">Chrome</a>
             version 25 or later.</p>
        </div>
        <div class="right">
          <button id="start_button" onclick="startButton(event)">
            <img id="start_img" src="mic.gif" alt="Start"></button>
        </div>
        <div id="results">
          <span id="final_span" class="final"></span>
          <span id="interim_span" class="interim"></span>
          <p>
        </div>
        <div class="center">
          <div class="sidebyside" style="text-align:right">
            <button id="copy_button" class="button" onclick="copyButton()">
              Copy and Paste</button>
            <div id="copy_info" class="info">
              Press Control-C to copy text.<br>(Command-C on Mac.)
            </div>
          </div>
          <div class="sidebyside">
            <button id="email_button" class="button" onclick="emailButton()">
              Create Email</button>
            <div id="email_info" class="info">
              Text sent to default email application.<br>
              (See chrome://settings/handlers to change.)
            </div>
          </div>
          <p>
          <div id="div_language">
            <select id="select_language" onchange="updateCountry()"></select>
            &nbsp;&nbsp;
            <select id="select_dialect"></select>
          </div>
        </div>
      </div>
  </div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>
<script>


//Global variable declarations;
var textToSpeech;
var session;
var inputMessage;
var session;

//Make touch events

//Get elements from html
var forward = $('#forward');
var left = $('#left');
var right = $('#right');
var back = $('#back');
var rotateLeft = $('#rotateLeft');
var rotateRight = $('#rotateRight');

//Toucha events function
function touchEvents (button, move1) {
  button.on("touchstart", move1);
  button.on("touchend", stopMove);
}

touchEvents(forward, moveForward);
touchEvents(left, moveLeft);
touchEvents(right, moveRight);
touchEvents(back, moveBackward);
touchEvents(rotateLeft, leftRotation);
touchEvents(rotateRight, rightRotation);


//=============================================================================//
//Connecting to nao
//declare function to start QiSession
function connect()
{
  session = new QiSession('192.168.10.103:80');
  session.socket().on('connect', function()
  {
    console.log("Connected!");
    $("#connect").addClass('disabled');
    $("#disconnect").removeClass('disabled');
    $("#tab2").removeClass('disabled');
    $("#tab3").removeClass('disabled');
    $("#tab4").removeClass('disabled');
    $('#controls').slideDown('slow');
    $('#controls2').slideDown('slow');
    $('#redLight').fadeOut('fast');
    $('#status').text('Connected');
    session.service("ALTextToSpeech").done(function(tts)
    {
       tts.say("Link established");
    });

    //Stop awareness mode.
    function stopAwareness() {
      session.service("ALBasicAwareness").done(function(tts)
      {
        tts.stopAwareness();
      })
    }

    stopAwareness();

  }).on('disconnect', function(){
    $("#disconnect").addClass('disabled');
    $("#connect").removeClass('disabled');
    $('#controls').slideUp('slow');
    $('#controls2').slideUp('slow');
    $('#status').html('Disconnected');
    $('#redLight').fadeIn('slow');
    $("#tab2").addClass('disabled');
    $("#tab3").addClass('disabled');
    $("#tab4").addClass('disabled');
    console.log("QiSession disconnect");
  });
}

function disconnect(){
  session.socket().disconnect();
}
//=============================================================================//

// Access the Robot on connected
$('#connect').on( 'click', function() {
    $.getScript( 'http://192.168.10.103/libs/qimessaging/1.0/qimessaging.js', function( data, textStatus, jqxhr ) {
      //Create QiSession
      connect();
    });
} );

$('#disconnect').on('click', function(){
    disconnect();
})
//Robot behavior functions

//MANUAL CONTROLS ====================================================//
//Movement keys
function moveForward(){
  //pressing on cell changes opacity
  session.service("ALMotion").done(function(tts)
  {
    tts.move(.2, 0, 0);
  });
}

function moveBackward(){
  //pressing on cell changes opacity
  session.service("ALMotion").done(function(tts)
  {
    tts.move(-.2, 0, 0);
  });
}

function moveLeft(){
  //pressing on cell changes opacity
  session.service("ALMotion").done(function(tts)
  {
    tts.move(0, .2, 0);
  });
}

function moveRight(){
  //pressing on cell changes opacity
  session.service("ALMotion").done(function(tts)
  {
    tts.move(0, -.2, 0);
  });
}

function leftRotation(){
  //pressing on cell changes opacity
  session.service("ALMotion").done(function(tts)
  {
    tts.move(0, 0, .2);
  });
}

function rightRotation(){
  //pressing on cell changes opacity
  session.service("ALMotion").done(function(tts)
  {
    tts.move(0, 0, -.2);
  });
}

function stopMove() {
  //pressing on cell changes opacity
  $(".cell").css('opacity', '1');
  session.service("ALMotion").done(function(tts)
  {
    tts.stopMove();
    tts.wakeUp();
  });
}
//Sleep and wake up.
function sleep() {
  session.service("ALMotion").done(function(tts)
  {
    tts.rest();
    $('#wakeUp').removeClass("disabled");
    $('#sleep').addClass("disabled");
  });
}

function wakeUp() {
  session.service("ALMotion").done(function(tts)
  {
    tts.wakeUp();
    $('#sleep').removeClass("disabled");
    $('#wakeUp').addClass("disabled");
  });
}

//Set Global volume
$('#globalVolume').change(function() {
  var currentVolume = $('#globalVolume').val();
  var volumeNumber = Number(currentVolume);
  session.service("ALAudioDevice").done(function(tts)
  {
    tts.setOutputVolume(volumeNumber);
  });
})

//Set Speech volume
function updateSpeechVolume(amount) {
  var volumeNumber = Number(amount);
        session.service("ALTextToSpeech").done(function(tts)
        {
          tts.setVolume(volumeNumber/100);
        });
    }
//Set speech pitch
function updatePitch(amount) {
  var amountNumber = Number(amount);
  session.service("ALTextToSpeech").done(function(tts)
  {
    tts.setParameter("pitchShift", amountNumber);
  });
}
//Set double voice ratio
function updateDoubleVoice(amount) {
  var amountNumber = Number(amount);
  session.service("ALTextToSpeech").done(function(tts)
  {
    tts.setParameter("doubleVoice", amountNumber);
  });
}
//Set double voice Volume
function updateDoubleVoiceLevel(amount) {
  var amountNumber = Number(amount);
  session.service("ALTextToSpeech").done(function(tts)
  {
    tts.setParameter("doubleVoiceLevel", amountNumber);
  });
}
//Set double voice delay
function updatedoubleVoiceTimeShift(amount) {
  var amountNumber = Number(amount);
  session.service("ALTextToSpeech").done(function(tts)
  {
    tts.setParameter("doubleVoiceTimeShift", amountNumber);
  });
}

//============================================================================//

//Text to speech with animations
function animatedSay(text){
  session.service("ALAnimatedSpeech").done(function(tts){
    tts.setBodyLanguageMode(1);
    tts.say(text);
  })
}

//Text on the html form to speech ============================================//
function speak(){

  session.service("ALAnimatedSpeech").done(function(tts)
  {
    tts.setBodyLanguageMode(1);
    tts.say(inputMessage);
  });
}

//when submit button is pressed, submit
$("#submitText").click(function() {
  inputMessage = $("#inputText").val();
  speak();
})

//hen 'enter' key is pressed, submit
document.getElementById('inputText').onkeydown = function(e){
   if ( (window.event ? event.keyCode : e.which) == 13) {
     inputMessage = $("#inputText").val();
     speak();
   }
};
//=========================================================================//


//Say hello with premade gesture
function hello () {
  session.service("ALBehaviorManager").done(function(tts)
  {
    tts.runBehavior("hello");
  });
  $('#stopAll').removeClass("disabled");
}

//=========================================================================//

//Stop all behaviors being executed
function stopBehavior() {
  session.service("ALBehaviorManager").done(function(tts)
  {
    tts.stopAllBehaviors();
    $('#stopAll').addClass("disabled");
  });
}

//=========================================================================//

//Use pre-made behaviors from robot memory
function answer(answerNumber) {
  session.service("ALBehaviorManager").done(function(tts)
  {
    tts.runBehavior("answer"+answerNumber+"");
  });
  $('#stopAll').removeClass("disabled");
}

//Use pre-made behaviors from robot memory
function video(videoNumber) {
  session.service("ALBehaviorManager").done(function(tts)
  {
    tts.runBehavior("video"+videoNumber+"");
  });
  $('#stopAll').removeClass("disabled");
}
//=========================================================================//

//Stand in position (in the event of falling);

function stand() {
  session.service("ALBehaviorManager").done(function(tts){
    tts.runBehavior("stand1");
  })
}


//Detect robot status and enable/disable sleep/wakeUp buttons
function getStatus() {
  session.service("ALMotion").done(function(tts)
  {
    tts.getStiffnesses("body");
    });
  }
  //=========================================================================//
  //=========================================================================//
  //=========================================================================//


//Speech recognition code//=========================================================================//

var langs =
[['Afrikaans',       ['af-ZA']],
 ['Bahasa Indonesia',['id-ID']],
 ['Bahasa Melayu',   ['ms-MY']],
 ['Català',          ['ca-ES']],
 ['Čeština',         ['cs-CZ']],
 ['Deutsch',         ['de-DE']],
 ['English',         ['en-AU', 'Australia'],
                     ['en-CA', 'Canada'],
                     ['en-IN', 'India'],
                     ['en-NZ', 'New Zealand'],
                     ['en-ZA', 'South Africa'],
                     ['en-GB', 'United Kingdom'],
                     ['en-US', 'United States']],
 ['Español',         ['es-AR', 'Argentina'],
                     ['es-BO', 'Bolivia'],
                     ['es-CL', 'Chile'],
                     ['es-CO', 'Colombia'],
                     ['es-CR', 'Costa Rica'],
                     ['es-EC', 'Ecuador'],
                     ['es-SV', 'El Salvador'],
                     ['es-ES', 'España'],
                     ['es-US', 'Estados Unidos'],
                     ['es-GT', 'Guatemala'],
                     ['es-HN', 'Honduras'],
                     ['es-MX', 'México'],
                     ['es-NI', 'Nicaragua'],
                     ['es-PA', 'Panamá'],
                     ['es-PY', 'Paraguay'],
                     ['es-PE', 'Perú'],
                     ['es-PR', 'Puerto Rico'],
                     ['es-DO', 'República Dominicana'],
                     ['es-UY', 'Uruguay'],
                     ['es-VE', 'Venezuela']],
 ['Euskara',         ['eu-ES']],
 ['Français',        ['fr-FR']],
 ['Galego',          ['gl-ES']],
 ['Hrvatski',        ['hr_HR']],
 ['IsiZulu',         ['zu-ZA']],
 ['Íslenska',        ['is-IS']],
 ['Italiano',        ['it-IT', 'Italia'],
                     ['it-CH', 'Svizzera']],
 ['Magyar',          ['hu-HU']],
 ['Nederlands',      ['nl-NL']],
 ['Norsk bokmål',    ['nb-NO']],
 ['Polski',          ['pl-PL']],
 ['Português',       ['pt-BR', 'Brasil'],
                     ['pt-PT', 'Portugal']],
 ['Română',          ['ro-RO']],
 ['Slovenčina',      ['sk-SK']],
 ['Suomi',           ['fi-FI']],
 ['Svenska',         ['sv-SE']],
 ['Türkçe',          ['tr-TR']],
 ['български',       ['bg-BG']],
 ['Pусский',         ['ru-RU']],
 ['Српски',          ['sr-RS']],
 ['한국어',            ['ko-KR']],
 ['中文',             ['cmn-Hans-CN', '普通话 (中国大陆)'],
                     ['cmn-Hans-HK', '普通话 (香港)'],
                     ['cmn-Hant-TW', '中文 (台灣)'],
                     ['yue-Hant-HK', '粵語 (香港)']],
 ['日本語',           ['ja-JP']],
 ['Lingua latīna',   ['la']]];

for (var i = 0; i < langs.length; i++) {
  select_language.options[i] = new Option(langs[i][0], i);
}
select_language.selectedIndex = 6;
updateCountry();
select_dialect.selectedIndex = 6;
showInfo('info_start');

function updateCountry() {
  for (var i = select_dialect.options.length - 1; i >= 0; i--) {
    select_dialect.remove(i);
  }
  var list = langs[select_language.selectedIndex];
  for (var i = 1; i < list.length; i++) {
    select_dialect.options.add(new Option(list[i][1], list[i][0]));
  }
  select_dialect.style.visibility = list[1].length == 1 ? 'hidden' : 'visible';
}

var create_email = false;
var final_transcript = '';
var recognizing = false;
var ignore_onend;
var start_timestamp;
if (!('webkitSpeechRecognition' in window)) {
  upgrade();
} else {
  start_button.style.display = 'inline-block';
  var recognition = new webkitSpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onstart = function() {
    recognizing = true;
    showInfo('info_speak_now');
    start_img.src = 'mic-animate.gif';
  };

  recognition.onerror = function(event) {
    if (event.error == 'no-speech') {
      start_img.src = 'mic.gif';
      showInfo('info_no_speech');
      ignore_onend = true;
    }
    if (event.error == 'audio-capture') {
      start_img.src = 'mic.gif';
      showInfo('info_no_microphone');
      ignore_onend = true;
    }
    if (event.error == 'not-allowed') {
      if (event.timeStamp - start_timestamp < 100) {
        showInfo('info_blocked');
      } else {
        showInfo('info_denied');
      }
      ignore_onend = true;
    }
  };

  recognition.onend = function() {
    recognizing = false;
    if (ignore_onend) {
      return;
    }
    start_img.src = 'mic.gif';
    if (!final_transcript) {
      showInfo('info_start');
      return;
    }
    showInfo('');
    if (window.getSelection) {
      window.getSelection().removeAllRanges();
      var range = document.createRange();
      range.selectNode(document.getElementById('final_span'));
      window.getSelection().addRange(range);
    }
    if (create_email) {
      create_email = false;
      createEmail();
    }
  };

  recognition.onresult = function(event) {
    var interim_transcript = '';
    for (var i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        final_transcript += event.results[i][0].transcript;
      } else {
        interim_transcript += event.results[i][0].transcript;
      }
    }
    final_transcript = capitalize(final_transcript);
    final_span.innerHTML = linebreak(final_transcript);
    interim_span.innerHTML = linebreak(interim_transcript);
    animatedSay(final_transcript);
    if (final_transcript || interim_transcript) {
      showButtons('inline-block');
    }
  };
}

function upgrade() {
  start_button.style.visibility = 'hidden';
  showInfo('info_upgrade');
}

var two_line = /\n\n/g;
var one_line = /\n/g;
function linebreak(s) {
  return s.replace(two_line, '<p></p>').replace(one_line, '<br>');
}

var first_char = /\S/;
function capitalize(s) {
  return s.replace(first_char, function(m) { return m.toUpperCase(); });
}

function createEmail() {
  var n = final_transcript.indexOf('\n');
  if (n < 0 || n >= 80) {
    n = 40 + final_transcript.substring(40).indexOf(' ');
  }
  var subject = encodeURI(final_transcript.substring(0, n));
  var body = encodeURI(final_transcript.substring(n + 1));
  window.location.href = 'mailto:?subject=' + subject + '&body=' + body;
}

function copyButton() {
  if (recognizing) {
    recognizing = false;
    recognition.stop();
  }
  copy_button.style.display = 'none';
  copy_info.style.display = 'inline-block';
  showInfo('');
}

function emailButton() {
  if (recognizing) {
    create_email = true;
    recognizing = false;
    recognition.stop();
  } else {
    createEmail();
  }
  email_button.style.display = 'none';
  email_info.style.display = 'inline-block';
  showInfo('');
}

function startButton(event) {
  if (recognizing) {
    recognition.stop();
    return;
  }
  final_transcript = '';
  recognition.lang = select_dialect.value;
  recognition.start();
  ignore_onend = false;
  final_span.innerHTML = '';
  interim_span.innerHTML = '';
  start_img.src = 'mic-slash.gif';
  showInfo('info_allow');
  showButtons('none');
  start_timestamp = event.timeStamp;
}

function showInfo(s) {
  if (s) {
    for (var child = info.firstChild; child; child = child.nextSibling) {
      if (child.style) {
        child.style.display = child.id == s ? 'inline' : 'none';
      }
    }
    info.style.visibility = 'visible';
  } else {
    info.style.visibility = 'hidden';
  }
}

var current_style;
function showButtons(style) {
  if (style == current_style) {
    return;
  }
  current_style = style;
  copy_button.style.display = style;
  email_button.style.display = style;
  copy_info.style.display = 'none';
  email_info.style.display = 'none';
}
</script>
</body>
</html>
